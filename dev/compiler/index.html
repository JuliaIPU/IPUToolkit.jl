<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Writing codelets · IPUToolkit.jl</title><meta name="title" content="Writing codelets · IPUToolkit.jl"/><meta property="og:title" content="Writing codelets · IPUToolkit.jl"/><meta property="twitter:title" content="Writing codelets · IPUToolkit.jl"/><meta name="description" content="Documentation for IPUToolkit.jl."/><meta property="og:description" content="Documentation for IPUToolkit.jl."/><meta property="twitter:description" content="Documentation for IPUToolkit.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">IPUToolkit.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">IPUToolkit</a></li><li><a class="tocitem" href="../poplar/">Poplar SDK</a></li><li class="is-active"><a class="tocitem" href>Writing codelets</a><ul class="internal"><li><a class="tocitem" href="#IPU-builtins"><span>IPU builtins</span></a></li><li><a class="tocitem" href="#Printing"><span>Printing</span></a></li><li><a class="tocitem" href="#Benchmarking"><span>Benchmarking</span></a></li><li><a class="tocitem" href="#Passing-non-constant-variables-from-global-scope"><span>Passing non-constant variables from global scope</span></a></li><li><a class="tocitem" href="#Debugging-compilation-errors-in-codelets"><span>Debugging compilation errors in codelets</span></a></li><li><a class="tocitem" href="#Domain-Specific-Language:-@ipuprogram"><span>Domain-Specific Language: <code>@ipuprogram</code></span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Writing codelets</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Writing codelets</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaIPU/IPUToolkit.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/main/docs/src/compiler.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Writing-codelets-in-Julia"><a class="docs-heading-anchor" href="#Writing-codelets-in-Julia">Writing codelets in Julia</a><a id="Writing-codelets-in-Julia-1"></a><a class="docs-heading-anchor-permalink" href="#Writing-codelets-in-Julia" title="Permalink"></a></h1><p>The <code>IPUToolkit.IPUCompiler</code> submodule allows you to write <a href="https://docs.graphcore.ai/projects/poplar-user-guide/en/3.2.0/vertices_overview.html">codelets</a> for the IPU in Julia. Codelets are defined with the <a href="#IPUToolkit.IPUCompiler.@codelet"><code>@codelet</code></a> macro, and then you can use them inside a program, written using the interface to the Poplar SDK described before. This mechanism uses the <a href="https://github.com/JuliaGPU/GPUCompiler.jl"><code>GPUCompiler.jl</code></a> package, which is a generic framework for generating LLVM IR code for specialised targets, not limited to GPUs despite the historical name.</p><p>Examples of codelets written in Julia are shown in the files <a href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/main/examples/main.jl"><code>examples/main.jl</code></a>, <a href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/main/examples/pi.jl"><code>examples/pi.jl</code></a>, <a href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/main/examples/adam.jl"><code>examples/adam.jl</code></a>, <a href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/main/examples/diffeq.jl"><code>examples/diffeq.jl</code></a>.</p><p>The code inside a codelet has the same limitations as all the compilation models based on <a href="https://github.com/JuliaGPU/GPUCompiler.jl"><code>GPUCompiler.jl</code></a>:</p><ul><li>the code has to be statically inferred and compiled, dynamic dispatch is not admitted;</li><li>you cannot use functionalities which require the Julia runtime, most notably the garbage collector;</li><li>you cannot call into any other external binary library at runtime, for example you cannot call into a BLAS library.</li></ul><p>After defining a codelet with <code>@codelet</code> you can add a vertex calling this codelet to the graph with the function <a href="#IPUToolkit.IPUCompiler.add_vertex"><code>add_vertex</code></a>, which also allows controlling the tile mapping in a basic way, or <code>Poplar.GraphAddVertex</code>.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@codelet" href="#IPUToolkit.IPUCompiler.@codelet"><code>IPUToolkit.IPUCompiler.@codelet</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@codelet graph &lt;function definition&gt;</code></pre><p>Define a codelet and add it to the <code>graph</code>. The <code>@codelet</code> macro takes two argument:</p><ul><li>the graph to which to add the codelet with the <a href="https://docs.graphcore.ai/projects/poplar-api/en/3.2.0/poplar/graph/Graph.html#_CPPv4N6poplar5Graph11addCodeletsE9StringRef15CodeletFileType9StringRef9StringRef"><code>Poplar.GraphAddCodelets</code></a> function;</li><li>the function definition of the codelet that you want to compile for the IPU device.</li></ul><p>All the arguments of the function must be either <a href="#IPUToolkit.IPUCompiler.VertexVector"><code>VertexVector</code></a>s, which represent the <a href="https://docs.graphcore.ai/projects/poplar-user-guide/en/3.2.0/vertex_vectors.html"><code>Vector</code></a> vertex type in the Poplar SDK, or <a href="#IPUToolkit.IPUCompiler.VertexScalar"><code>VertexScalar</code></a>s, which represent scalar arguments. The function passed as second argument to <code>@codelet</code> should have a single method.</p><p><code>@codelet</code> defines the function passed as argument, generates its LLVM Intermediate Representation (IR) using <code>GPUCompiler.jl</code> and then compiles it down to native code using the Poplar compiler <code>popc</code>, which must be in <a href="https://en.wikipedia.org/wiki/PATH_(variable)"><code>PATH</code></a>. By default the LLVM IR of the function is written to a temporary file, but you can choose to keep it in the current directory by customising <a href="#IPUToolkit.IPUCompiler.KEEP_LLVM_FILES"><code>IPUCompiler.KEEP_LLVM_FILES</code></a>. You can control flags passed to the <code>popc</code> compiler like debug and optimisation levels or target types by customising <a href="#IPUToolkit.IPUCompiler.POPC_FLAGS"><code>IPUCompiler.POPC_FLAGS</code></a>. During compilation of codelets a spinner is displayed to show the progress, as this step can take a few seconds for each codelet to be generated. This can be disabled by setting <a href="#IPUToolkit.IPUCompiler.PROGRESS_SPINNER"><code>IPUCompiler.PROGRESS_SPINNER</code></a>. All the options mentioned in this section have to be set before the <code>@codelet</code> invocation where you want them to have effect.</p><p>The codelet is automatically added to the graph but you will have to separately use it in a vertex, by using either the <a href="#IPUToolkit.IPUCompiler.add_vertex"><code>add_vertex</code></a> function, or Poplar&#39;s <a href="https://docs.graphcore.ai/projects/poplar-api/en/3.2.0/poplar/graph/Graph.html#_CPPv4N6poplar5Graph9addVertexE10ComputeSet9StringRef"><code>Poplar.GraphAddVertex</code></a>.</p><p><strong>Example</strong></p><pre><code class="language-julia hljs">using IPUToolkit.IPUCompiler, IPUToolkit.Poplar
device = Poplar.get_ipu_device()
target = Poplar.DeviceGetTarget(device)
graph = Poplar.Graph(target)
@codelet graph function test(in::VertexVector{Int32,In}, out::VertexVector{Float32,Out})
    for idx in eachindex(out)
        out[idx] = sin(in[idx])
    end
end</code></pre><p>This snippet of code defines a codelet called <code>test</code>, which takes in input the vector <code>in</code>, whose elements are <code>Int32</code>s, and modifies the vector <code>out</code>, of type <code>Float32</code>, by computing the sine of the elements of <code>in</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/codelet.jl#L76-L112">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.VertexVector" href="#IPUToolkit.IPUCompiler.VertexVector"><code>IPUToolkit.IPUCompiler.VertexVector</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">VertexVector{T, S} &lt;: AbstractVector{T}</code></pre><p>This datatype formally represents vectors to be used in codelets (vertices) in IPU programs. They are the counterpart of the <a href="https://docs.graphcore.ai/projects/poplar-user-guide/en/3.2.0/vertex_vectors.html">vertex vector types</a> in the Poplar SDK.</p><p>The parameters of <code>VertexVector{T,S}</code> are</p><ul><li><code>T</code>: the type of the elements of the vector, e.g. <code>Int32</code>, <code>Float32</code>, etc.;</li><li><code>S</code>: the scope of the vector in the codelet, <code>In</code>, <code>Out</code>, or <code>InOut</code>.</li></ul><p><code>VertexVector</code> is only meant to be used by end-user to define the arguments of codelets with the <a href="#IPUToolkit.IPUCompiler.@codelet"><code>@codelet</code></a> macro. You should not try to manually instantiate or access the fields of a <code>VertexVector</code>.</p><p>For scalar arguments use <a href="#IPUToolkit.IPUCompiler.VertexScalar"><code>VertexScalar</code></a>.</p><p><strong>Example</strong></p><pre><code class="language-julia hljs">VertexVector{Float32, In}    # input-only vector of `Float32` elements
VertexVector{Int32, Out}     # output-only vector of `Int32` elements
VertexVector{UInt32, InOut}  # input/output vector of `UInt32` elements</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/vertices.jl#L9-L32">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.VertexScalar" href="#IPUToolkit.IPUCompiler.VertexScalar"><code>IPUToolkit.IPUCompiler.VertexScalar</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">VertexScalar{T, S}</code></pre><p>This datatype formally represents scalars to be used in codelets (vertices) in IPU programs. Technically, these are implemented as single-element tensors.</p><p>The parameters of <code>VertexScalar{T,S}</code> are</p><ul><li><code>T</code>: the type of the scalar, e.g. <code>Int32</code>, <code>Float32</code>, etc.;</li><li><code>S</code>: the scope of the scalar in the codelet, <code>In</code>, <code>Out</code>, or <code>InOut</code>.</li></ul><p><code>VertexScalar</code> is only meant to be used by end-user to define the arguments of codelets with the <a href="#IPUToolkit.IPUCompiler.@codelet"><code>@codelet</code></a> macro. You should not try to manually instantiate or access the fields of a <code>VertexScalar</code>.</p><p>Inside a codelet you can access and set the number by unwrapping it with <code>[]</code>.</p><p>For vector arguments use <a href="#IPUToolkit.IPUCompiler.VertexVector"><code>VertexVector</code></a>.</p><p><strong>Example</strong></p><p>Examples of types</p><pre><code class="language-julia hljs">VertexScalar{Float32, In}    # input-only `Float32` number
VertexScalar{Int32, Out}     # output-only `Int32` number
VertexScalar{UInt32, InOut}  # input/output `UInt32` number</code></pre><p>Inside a codelet, let <code>x</code> have type <code>VertexScalar</code>, you can access its value if it has scope <code>In</code> or <code>InOut</code> with</p><pre><code class="language-julia hljs">@ipushow x[]
y = x[] / 3.14</code></pre><p>If <code>x</code> has scope <code>Out</code> or <code>InOut</code> you can set its value with <code>x[] = ...</code>:</p><pre><code class="language-julia hljs">x[] = 3.14</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/vertices.jl#L80-L120">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.add_vertex" href="#IPUToolkit.IPUCompiler.add_vertex"><code>IPUToolkit.IPUCompiler.add_vertex</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">add_vertex(graph::Poplar.GraphAllocated,
           compute_set_or_program::Union{Poplar.ComputeSetAllocated, Poplar.ProgramSequenceAllocated},
           [tiles::Union{Integer,AbstractVector{&lt;:Integer}},]
           codelet::Function,
           args::Union{Number,Poplar.TensorAllocated}...) -&gt; Nothing</code></pre><p>Add the codelet function <code>codelet</code> created with <a href="#IPUToolkit.IPUCompiler.@codelet"><code>@codelet</code></a> to <code>graph</code>, using the tensors <code>args</code> as arguments. The function <code>codelet</code> must have exactly one method, no more, no less. The second argument can be either the program or the compute set to which to add the new vertex/vertices. If a program is passed, a new compute set will be automatically created.</p><p><code>add_vertex</code> also evenly maps all tensors and vertices across all <code>tiles</code>, which can be either a single tile ID or an <code>AbstractVector</code> of IDs and defaults to single tile 0 if this argument is omitted. Note that all argument tensors <code>args</code> must be longer than or equal to the number of <code>tiles</code>. If you want to have better control over tile mapping, use <code>Poplar.GraphAddVertex</code> instead.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/compiler.jl#L173-L188">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.TARGET_COLOSSUS" href="#IPUToolkit.IPUCompiler.TARGET_COLOSSUS"><code>IPUToolkit.IPUCompiler.TARGET_COLOSSUS</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.TARGET_COLOSSUS::Base.RefValue{Bool}</code></pre><p>Option to control whether to target the Colossus backend when generating the LLVM Intermediate Representation (IR) of the codelets. If set to <code>false</code>, the default, codelets will generate code for the host machine, which may be inefficient, while still being valid.</p><div class="admonition is-info" id="Note-9901c9747fbe34e7"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-9901c9747fbe34e7" title="Permalink"></a></header><div class="admonition-body"><p>You can target the Colossus backend only if your Julia links to a version of libllvm compiled from <a href="https://github.com/graphcore/llvm-project-fork">Graphcore&#39;s fork of LLVM</a>.</p></div></div><div class="admonition is-warning" id="Warning-3e0fafe0cc56cfa1"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-3e0fafe0cc56cfa1" title="Permalink"></a></header><div class="admonition-body"><p>This option is experimental, Julia code generation using Graphcore&#39;s LLVM has not been tested extensively and is known to cause miscompilations, unexpected errors may happen.</p></div></div><p><strong>Example</strong></p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.TARGET_COLOSSUS[] = false # Generate LLVM IR for the host, the default
IPUToolkit.IPUCompiler.TARGET_COLOSSUS[] = true  # Generate LLVM IR for the Colossus backend</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/codelet.jl#L148-L168">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.KEEP_LLVM_FILES" href="#IPUToolkit.IPUCompiler.KEEP_LLVM_FILES"><code>IPUToolkit.IPUCompiler.KEEP_LLVM_FILES</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.KEEP_LLVM_FILES::Base.RefValue{Bool}</code></pre><p>Option to control whether to keep in the current directory the files with the LLVM Intermediate Representation (IR) generated for the codelets.</p><p><strong>Example</strong></p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.KEEP_LLVM_FILES[] = false # Generated LLVM IR files are automatically deleted after compilation, default
IPUToolkit.IPUCompiler.KEEP_LLVM_FILES[] = true  # Generated LLVM IR files are kept in the current directory</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/codelet.jl#L134-L145">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.POPC_FLAGS" href="#IPUToolkit.IPUCompiler.POPC_FLAGS"><code>IPUToolkit.IPUCompiler.POPC_FLAGS</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.POPC_FLAGS::Base.RefValue{Cmd}</code></pre><p>Options to pass to the <code>popc</code> compiler to compile the code.</p><p><strong>Example</strong></p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.POPC_FLAGS = `-O3 -g0 -target ipu2`
IPUToolkit.IPUCompiler.POPC_FLAGS = `-O2 -g`</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/codelet.jl#L120-L131">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.PROGRESS_SPINNER" href="#IPUToolkit.IPUCompiler.PROGRESS_SPINNER"><code>IPUToolkit.IPUCompiler.PROGRESS_SPINNER</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.PROGRESS_SPINNER::Base.RefValue{Bool}</code></pre><p>Option to control whether to display a spinner to show progress during compilation of IPU codelets. This is forcibly disabled if <a href="#IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS"><code>DEBUG_COMPILATION_ERRORS</code></a> is <code>true</code>.</p><p><strong>Example</strong></p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.PROGRESS_SPINNER[] = true  # enable spinner, default
IPUToolkit.IPUCompiler.PROGRESS_SPINNER[] = false # disable spinner</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/codelet.jl#L6-L18">source</a></section></article><h2 id="IPU-builtins"><a class="docs-heading-anchor" href="#IPU-builtins">IPU builtins</a><a id="IPU-builtins-1"></a><a class="docs-heading-anchor-permalink" href="#IPU-builtins" title="Permalink"></a></h2><p>Inside codelets defined with <a href="#IPUToolkit.IPUCompiler.@codelet"><code>@codelet</code></a> all calls to random functions</p><ul><li><code>rand(Float16)</code></li><li><code>rand(Float32)</code></li><li><code>rand(UInt32)</code></li><li><code>rand(UInt64)</code></li><li><code>randn(Float16)</code></li><li><code>randn(Float32)</code></li></ul><p>result to call to corresponding IPU builtins for <a href="https://docs.graphcore.ai/projects/poplar-api/en/latest/ipu_intrinsics/ipu_builtins.html#random-number-generation">random number generation</a>. The uniformly distributed numbers follow the general semantic of the Julia function <code>rand</code> (floating point numbers are uniformely distributed in the <span>$[0, 1)$</span> range), while the normally distributed numbers have the properties described in the Poplar SDK documentation (numbers are in the range <span>$[-93/16, 93/16]$</span>).</p><div class="admonition is-info" id="Note-39abdc59d78c0fca"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-39abdc59d78c0fca" title="Permalink"></a></header><div class="admonition-body"><p>The IPU builtins for random numbers return pairs of numbers, but the Julia functions <code>randn(Float16)</code> and <code>randn(Float32)</code> return only a single number, discarding the second number of the pair. If you have a vector of even length that you want to fill in-place with normally distributed numbers, you can use the <a href="#IPUToolkit.IPUCompiler.randn2!"><code>randn2!</code></a> function to do that efficiently, without discarding any number.</p></div></div><p>Additionally, you can use the <a href="https://docs.graphcore.ai/projects/poplar-api/en/latest/ipu_intrinsics/ipu_builtins.html">IPU builtins</a> listed below.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.get_scount_l" href="#IPUToolkit.IPUCompiler.get_scount_l"><code>IPUToolkit.IPUCompiler.get_scount_l</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_scount_l()</code></pre><p>Call the <a href="https://docs.graphcore.ai/projects/poplar-api/en/latest/ipu_intrinsics/ipu_builtins.html#_CPPv426__builtin_ipu_get_scount_lv"><code>__builtin_ipu_get_scount_l()</code></a> builtin:</p><blockquote><p>Get the value of the control/status register (CSR) <code>SCOUNT_L</code>, which is the lower 32 bits of the tile cycle counter value.</p></blockquote></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/compiler.jl#L58-L64">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.get_tile_id" href="#IPUToolkit.IPUCompiler.get_tile_id"><code>IPUToolkit.IPUCompiler.get_tile_id</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">get_tile_id()</code></pre><p>Call the <a href="https://docs.graphcore.ai/projects/poplar-api/en/latest/ipu_intrinsics/ipu_builtins.html#_CPPv425__builtin_ipu_get_tile_idv"><code>__builtin_ipu_get_tile_id()</code></a> builtin:</p><blockquote><p>Get the tile ID of the current tile.</p></blockquote></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/compiler.jl#L66-L72">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.randn2!" href="#IPUToolkit.IPUCompiler.randn2!"><code>IPUToolkit.IPUCompiler.randn2!</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">randn2!(v::VertexVector) -&gt; v</code></pre><p>Fill the vector <code>v</code> with normally-distributed (mean 0, standard deviation 1) random numbers. The vector <em>must</em> have even length. This function takes advantage of <a href="https://docs.graphcore.ai/projects/poplar-api/en/latest/ipu_intrinsics/ipu_builtins.html#random-number-generation">IPU builtins for random number generation</a>, which return pairs of numbers at a time.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/compiler.jl#L75-L81">source</a></section></article><h2 id="Printing"><a class="docs-heading-anchor" href="#Printing">Printing</a><a id="Printing-1"></a><a class="docs-heading-anchor-permalink" href="#Printing" title="Permalink"></a></h2><p>Inside codelets you can print text and value of variables using the macros <a href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>@ipuprintf</code></a>, <a href="#IPUToolkit.IPUCompiler.@ipuprint"><code>@ipuprint</code></a>, <a href="#IPUToolkit.IPUCompiler.@ipuprintln"><code>@ipuprintln</code></a>, and <a href="#IPUToolkit.IPUCompiler.@ipushow"><code>@ipushow</code></a>. These macros are useful for debugging purposes but printing inside a codelet might incur performance penalty. To completely disable all printing and make these macros no-op you can set <a href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUCompiler.DISABLE_PRINT</code></a>:</p><pre><code class="language-julia hljs">IPUCompiler.DISABLE_PRINT[] = true</code></pre><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipuprintf" href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>IPUToolkit.IPUCompiler.@ipuprintf</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipuprintf(&quot;%Fmt&quot;, args...)</code></pre><p>Print a formatted string in device context on the host standard output.</p><p>Note that this is not a fully C-compliant <code>printf</code> implementation.</p><p>Also beware that it is an untyped, and unforgiving <code>printf</code> implementation. Type widths need to match, eg. printing a 64-bit Julia integer requires the <code>%ld</code> formatting string.</p><p>More user-friendly versions of this macro are <a href="#IPUToolkit.IPUCompiler.@ipuprint"><code>@ipuprint</code></a>, <a href="#IPUToolkit.IPUCompiler.@ipuprintln"><code>@ipuprintln</code></a>. See also <a href="#IPUToolkit.IPUCompiler.@ipushow"><code>@ipushow</code></a>, which is built on top of <code>@ipuprintf</code> functionalities.</p><p>Printing can be completely disabled by setting <a href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUCompiler.DISABLE_PRINT</code></a>:</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/output.jl#L43-L60">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipuprint" href="#IPUToolkit.IPUCompiler.@ipuprint"><code>IPUToolkit.IPUCompiler.@ipuprint</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipuprint(xs...)
@ipuprintln(xs...)</code></pre><p>Print a textual representation of values <code>xs</code> to standard output from the IPU. The functionality builds on <a href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>@ipuprintf</code></a>, and is intended as a more use friendly alternative of that API. However, that also means there&#39;s only limited support for argument types, handling 16/32/64 signed and unsigned integers, 32 and 64-bit floating point numbers, <code>Cchar</code>s and pointers. For more complex output, use <a href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>@ipuprintf</code></a> directly.</p><p>Limited string interpolation is also possible:</p><pre><code class="language-julia hljs">    @ipuprint(&quot;Hello, World &quot;, 42, &quot;\n&quot;)
    @ipuprint &quot;Hello, World $(42)\n&quot;</code></pre><p>Printing can be completely disabled by setting <a href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUCompiler.DISABLE_PRINT</code></a>:</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/output.jl#L227-L248">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipuprintln" href="#IPUToolkit.IPUCompiler.@ipuprintln"><code>IPUToolkit.IPUCompiler.@ipuprintln</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipuprint(xs...)
@ipuprintln(xs...)</code></pre><p>Print a textual representation of values <code>xs</code> to standard output from the IPU. The functionality builds on <a href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>@ipuprintf</code></a>, and is intended as a more use friendly alternative of that API. However, that also means there&#39;s only limited support for argument types, handling 16/32/64 signed and unsigned integers, 32 and 64-bit floating point numbers, <code>Cchar</code>s and pointers. For more complex output, use <a href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>@ipuprintf</code></a> directly.</p><p>Limited string interpolation is also possible:</p><pre><code class="language-julia hljs">    @ipuprint(&quot;Hello, World &quot;, 42, &quot;\n&quot;)
    @ipuprint &quot;Hello, World $(42)\n&quot;</code></pre><p>Printing can be completely disabled by setting <a href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUCompiler.DISABLE_PRINT</code></a>:</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/output.jl#L285">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipushow" href="#IPUToolkit.IPUCompiler.@ipushow"><code>IPUToolkit.IPUCompiler.@ipushow</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipushow(ex)</code></pre><p>IPU analogue of <code>Base.@show</code>. It comes with the same type restrictions as <a href="#IPUToolkit.IPUCompiler.@ipuprintf"><code>@ipuprintf</code></a>.</p><pre><code class="language-julia hljs">@ipushow x</code></pre><p>Printing can be completely disabled by setting <a href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUCompiler.DISABLE_PRINT</code></a>:</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/output.jl#L294-L307">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.DISABLE_PRINT" href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUToolkit.IPUCompiler.DISABLE_PRINT</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT::Base.RefValue{Bool}</code></pre><p>Global constant which controls whether printing through the various <code>@ipuprint*</code> macros should be disabled or not.  You may want to completely disable printing for production runs, to avoid the cost of printing on the device, but keep it enabled during development.</p><p>Examples:</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = false # Do not disable printing, this is the default.
IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true  # Disable printing, the `@ipuprint*` macros are no-op.</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/output.jl#L10-L24">source</a></section></article><h2 id="Benchmarking"><a class="docs-heading-anchor" href="#Benchmarking">Benchmarking</a><a id="Benchmarking-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmarking" title="Permalink"></a></h2><p>To benchmark expressions inside codelets you can use the macros <a href="#IPUToolkit.IPUCompiler.@ipucycles"><code>@ipucycles</code></a>, <a href="#IPUToolkit.IPUCompiler.@ipushowcycles"><code>@ipushowcycles</code></a>, and <a href="#IPUToolkit.IPUCompiler.@ipuelapsed"><code>@ipuelapsed</code></a>, which report the number of cycles spent in the wrapped expression. They are similar to Julia&#39;s <code>@time</code>, <code>@showtime</code>, and <code>@elapsed</code> macros, but report the number of cycles, as the clockspeed of tiles cannot be easily obtained <em>inside</em> a codelet. The corresponding time can be obtained by dividing the number of cycles by the clock frequency of the the tile, which you can get with <a href="https://docs.graphcore.ai/projects/poplar-api/en/latest/poplar/device/Target.html#_CPPv4NK6poplar6Target21getTileClockFrequencyEv"><code>Poplar.TargetGetTileClockFrequency(target)</code></a> outside of the codelet, and should usually be 1.330 GHz or 1.850 GHz depending on the model of your IPU. The printing macros <code>@ipucycles</code> and <code>@ipushowcycles</code> can be made completely no-op by setting <a href="#IPUToolkit.IPUCompiler.DISABLE_PRINT"><code>IPUCompiler.DISABLE_PRINT</code></a>.</p><div class="admonition is-warning" id="Warning-1f5991aefed00d22"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-1f5991aefed00d22" title="Permalink"></a></header><div class="admonition-body"><p>Timing of expressions taking longer than <code>typemax(UInt32) / tile_clock_frequency</code> (about 2 or 3 seconds depending on your IPU model) is unreliable because the difference between the starting and the ending cycle counts would overflow.</p><p>Note also that the <code>Poplar.TargetGetTileClockFrequency(target)</code> function <a href="https://github.com/UoB-HPC/ipu-hpc-cookbook/blob/96a37c2f7c745fb4e1ca0bc12fa68fe39df067a7/timing-program-execution/README.md#using-counters-on-the-ipu">may not return a reliable value</a>, but this is an upstream bug (this has been observed at least up to Poplar SDK v3.0). You may have to use tools like <code>gc-monitor</code>, <code>gc-inventory</code>, or <code>gc-info --device-id &lt;N&gt; --tile-clock-speed</code> to obtain the correct tile clock frequency.</p></div></div><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipucycles" href="#IPUToolkit.IPUCompiler.@ipucycles"><code>IPUToolkit.IPUCompiler.@ipucycles</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipucycles ex
@ipucycles &quot;description&quot; ex</code></pre><p>Print from inside a codelet the number of cycles spent to compute the expression <code>ex</code>. The corresponding time can be obtained by dividing the number of cycles by the clock frequency of the the tile, which you can get with <code>Poplar.TargetGetTileClockFrequency(target)</code> outside of the codelet. The optional argument <code>description</code>, a literal <code>String</code>, can be used to print also a label to identify the timed expression. A label is added automatically by <a href="#IPUToolkit.IPUCompiler.@ipushowcycles"><code>@ipushowcycles</code></a>.</p><p>See also <a href="#IPUToolkit.IPUCompiler.@ipuelapsed"><code>@ipuelapsed</code></a>.</p><p>This macro can be made no-op completely by setting</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/timing.jl#L52-L67">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipushowcycles" href="#IPUToolkit.IPUCompiler.@ipushowcycles"><code>IPUToolkit.IPUCompiler.@ipushowcycles</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipushowcycles ex</code></pre><p>Print from inside a codelet the expression <code>ex</code> and the number of cycles spent to compute it. This is useful when benchmarking multiple expression, to identify their contributions more easily. The corresponding time can be obtained by dividing the number of cycles by the clock frequency of the the tile, which you can get with <code>Poplar.TargetGetTileClockFrequency(target)</code> outside of the codelet.</p><p>See also <a href="#IPUToolkit.IPUCompiler.@ipucycles"><code>@ipucycles</code></a>, <a href="#IPUToolkit.IPUCompiler.@ipuelapsed"><code>@ipuelapsed</code></a>.</p><p>This macro can be made no-op completely by setting</p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DISABLE_PRINT[] = true</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/timing.jl#L70-L83">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.@ipuelapsed" href="#IPUToolkit.IPUCompiler.@ipuelapsed"><code>IPUToolkit.IPUCompiler.@ipuelapsed</code></a> — <span class="docstring-category">Macro</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">@ipuelapsed ex</code></pre><p>Return number of cycles spent to compute the expression <code>ex</code>. The corresponding time can be obtained by dividing the number of cycles by the clock frequency of the the tile, which you can get with <code>Poplar.TargetGetTileClockFrequency(target)</code> outside of the codelet.</p><p>See also <a href="#IPUToolkit.IPUCompiler.@ipucycles"><code>@ipucycles</code></a>, <a href="#IPUToolkit.IPUCompiler.@ipushowcycles"><code>@ipushowcycles</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/timing.jl#L90-L97">source</a></section></article><h2 id="Passing-non-constant-variables-from-global-scope"><a class="docs-heading-anchor" href="#Passing-non-constant-variables-from-global-scope">Passing non-constant variables from global scope</a><a id="Passing-non-constant-variables-from-global-scope-1"></a><a class="docs-heading-anchor-permalink" href="#Passing-non-constant-variables-from-global-scope" title="Permalink"></a></h2><p>If your kernel references a non-constant (<code>const</code>) global variable, the generated code will result in a reference to a memory address on the host, and this will fatally fail at runtime because programs running on the IPU don&#39;t have access to the host memory. Constant variables are not affected by this problem because their values are inlined when the function is compiled. If you can&#39;t or don&#39;t want to make a variable constant you can interpolate its value with a top-level <a href="https://docs.julialang.org/en/v1/base/base/#Base.@eval"><code>@eval</code></a> when defining the codelet. For example:</p><pre><code class="language-julia hljs">using IPUToolkit.IPUCompiler, IPUToolkit.Poplar
device = Poplar.get_ipu_device()
target = Poplar.DeviceGetTarget(device)
graph = Poplar.Graph(target)
tile_clock_frequency = Poplar.TargetGetTileClockFrequency(target)
@eval @codelet graph function test(invec::VertexVector{Float32, In}, outvec::VertexVector{Float32, Out})
    # We can use the intrinsic `get_scount_l` to get the cycle counter right
    # before and after some operations, so that we can benchmark it.
    cycles_start = get_scount_l()
    # Do some operations here...
    cycles_end = get_scount_l()
    # Divide the difference between the two cycle counts by the tile frequency
    # clock to get the time.
    time = (cycles_end - cycles_start) / $(tile_clock_frequency)
    # Show the time spent doing your operations
    @ipushow time
end</code></pre><p>The use of <code>@eval</code> allows you not to have to pass an extra argument to your kernel just to use the value of the variable inside the codelet.</p><h2 id="Debugging-compilation-errors-in-codelets"><a class="docs-heading-anchor" href="#Debugging-compilation-errors-in-codelets">Debugging compilation errors in codelets</a><a id="Debugging-compilation-errors-in-codelets-1"></a><a class="docs-heading-anchor-permalink" href="#Debugging-compilation-errors-in-codelets" title="Permalink"></a></h2><p>Writing codelets for the IPU takes some practice, because you cannot use any arbitrary construct or package as you would normally do when running code on a CPU. As mentioned above, codelets have to be statically compiled with <code>GPUCompiler.jl</code>, with all the limitations of this framework, which can only use a subset of the Julia language. Therefore, it happens frequently that you run into compilation errors while developing a codelet function, and you have then to resolve the issues, which usually involves removing <a href="https://en.wikipedia.org/wiki/Dynamic_dispatch">dynamic dispatch</a> calls (which would require the JIT compiler at runtime), resolving <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#Write-%22type-stable%22-functions">type-instabilities</a>, <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#Measure-performance-with-[@time](@ref)-and-pay-attention-to-memory-allocation">avoiding memory allocations</a>, etc... If you have <a href="https://github.com/JuliaDebug/Cthulhu.jl"><code>Cthulhu.jl</code></a> installed, you can set <a href="#IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS"><code>IPUCompiler.DEBUG_COMPILATION_ERRORS</code></a> to <code>true</code> to automatically open an interactive shell when compiling a codelet results into invalid LLVM IR, to more easily debug the codelet code.</p><p>We suggest again taking a look at the code samples in the <a href="https://github.com/JuliaIPU/IPUToolkit.jl/tree/main/examples"><code>examples/</code></a> directory for learning how to write working IPU codelets in Julia.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS" href="#IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS"><code>IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS</code></a> — <span class="docstring-category">Constant</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS::Base.RefValue{Bool}</code></pre><p>Option to control whether a failure to compile LLVM IR in <a href="#IPUToolkit.IPUCompiler.@codelet"><code>@codelet</code></a> should drop you into an interactive debug session with <a href="https://github.com/JuliaDebug/Cthulhu.jl"><code>Cthulhu.jl</code></a>. This forcibly disables the progress spinner enabled by <a href="#IPUToolkit.IPUCompiler.PROGRESS_SPINNER"><code>PROGRESS_SPINNER</code></a>, as it would not play nicely with the interactive debug session.</p><div class="admonition is-info" id="Note-46f6fa07816b7cb0"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-46f6fa07816b7cb0" title="Permalink"></a></header><div class="admonition-body"><p><a href="https://github.com/JuliaDebug/Cthulhu.jl"><code>Cthulhu.jl</code></a> must be installed in the environment you are currently using and you have to run <code>using Cthulhu</code> before the <code>@codelet</code> definition. <code>IPUToolkit.jl</code> does not install <code>Cthulhu.jl</code> automatically to limit the number of dependencies.</p></div></div><p><strong>Example</strong></p><pre><code class="language-julia hljs">IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS[] = false # Do not automatically open interactive debug shell when a compilation error arises, the default
IPUToolkit.IPUCompiler.DEBUG_COMPILATION_ERRORS[] = true  # Automatically open interactive debug shell when a compilation error arises</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/2582bb90843328b1065a2ce4fae6285a11400abd/src/compiler/codelet.jl#L171-L188">source</a></section></article><h2 id="Domain-Specific-Language:-@ipuprogram"><a class="docs-heading-anchor" href="#Domain-Specific-Language:-@ipuprogram">Domain-Specific Language: <code>@ipuprogram</code></a><a id="Domain-Specific-Language:-@ipuprogram-1"></a><a class="docs-heading-anchor-permalink" href="#Domain-Specific-Language:-@ipuprogram" title="Permalink"></a></h2><p>The <code>IPUCompiler.@ipuprogram</code> macro provides a very simple and limited DSL to automatically generate most of the boilerplate code needed when writing an IPU program. You can do <em>very</em> little with this DSL, which is mainly a showcase of Julia&#39;s meta-programming capabilities. A fully commented examples of use of the <code>@ipuprogram</code> macro is available in the <a href="https://github.com/JuliaIPU/IPUToolkit.jl/blob/main/examples/dsl.jl"><code>examples/dsl.jl</code></a> file.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../poplar/">« Poplar SDK</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Sunday 31 August 2025 15:12">Sunday 31 August 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
